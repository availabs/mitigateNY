import{u as De,r as S,C as Ne,L as Me,z as fe,e,A as Oe,g as Te,c as V,j as m,F as Se,b as _e,D as me,G as Re,I as ge,H as oe,J as we,M as $e,N as Ie,O as Ae}from"./index-45ac37f7.js";import{L as Le}from"./LexicalNestedComposer-9dfec8cb.js";const J=[];function Pe(){const l=e.$createRangeSelection();return l.focus.set("root",e.$getRoot().getChildrenSize(),"element"),l}function ke(l){return`<p class="${l.paragraph}"><br></p>`}function ue(l,s){const i=l.querySelector(`[data-id=${s}]`);i!=null&&i.focus()}function Ye(l){return l.nodeType===1&&l.hasAttribute("data-table-resize")}function ve(l,s){const i=s.parseEditorState(l);let u=me.get(l);if(u===void 0){u=i.read(()=>Re.$generateHtmlFromNodes(s,null));const E=i.read(()=>e.$getRoot().getTextContent());me.set(l,u),fe.set(l,E)}return u}function Ce(l){const s=l.getRootElement();return s!==null?s.ownerDocument:document}function Ke(l,s,i,u){return s?!1:l===67?ge?i:u:!1}function Ue(l,s,i,u){return s?!1:l===88?ge?i:u:!1}function We(l,s,i,u){return s?!1:l===86?ge?i:u:!1}function de(l){let s=l;for(;s!==null;){const i=s.getAttribute("data-id");if(i!=null)return i;s=s.parentElement}return null}function ze(l){let s=l;for(;s!==null;){if(s.nodeName==="TH"||s.nodeName==="TD")return s.getBoundingClientRect().width;s=s.parentElement}return 0}function Q(l,s,i,u,E,x){for(const R of s){const w=ae(l,R,i);if(w!==null&&u!==null){const $=u.parseEditorState(w.json);u._headless=!0,u.setEditorState($),u.update(x,{discrete:!0}),u._headless=!1;const k=JSON.stringify(u.getEditorState());E(D=>{const[T,L]=i.get(R);e.$addUpdateTag("history-push"),D.updateCellJSON(T,L,k)})}}}function Xe(l){let s=l;for(;s!==null;){const i=s.nodeName;if(i==="BUTTON"||i==="INPUT"||i==="TEXTAREA")return!0;s=s.parentElement}return!1}function xe(l,s,i){const u=i.get(l),E=i.get(s);if(u===void 0||E===void 0)return null;const x=Math.min(u[0],E[0]),R=Math.max(u[0],E[0]),w=Math.min(u[1],E[1]),$=Math.max(u[1],E[1]);return{endX:R,endY:$,startX:x,startY:w}}function he(l,s,i,u){const E=xe(s,i,u);if(E===null)return[];const{startX:x,endY:R,endX:w,startY:$}=E,k=[];for(let D=x;D<=w;D++)for(let T=$;T<=R;T++)k.push(l[T].cells[D].id);return k}function Be(l,s){const{startX:i,endY:u,endX:E,startY:x}=s,R=[];for(let w=x;w<=u;w++){const $=l[w],k=Ie();for(let D=i;D<=E;D++){const T={...$.cells[D]};T.id=Ae(),k.cells.push(T)}R.push(k)}return R}function He({cellEditor:l}){const{cellEditorConfig:s,cellEditorPlugins:i}=S.useContext(Ne);return i===null||s===null?null:m(Le.LexicalNestedComposer,{initialEditor:l,initialTheme:s.theme,initialNodes:s.nodes,skipCollabChecks:!0,children:i})}function ae(l,s,i){const u=i.get(s);if(u===void 0)return null;const[E,x]=u;return l[x].cells[E]}function Je({cell:l,rows:s,cellCoordMap:i,menuElem:u,updateCellsByID:E,onClose:x,updateTableNode:R,setSortingOptions:w,sortingOptions:$}){const k=S.useRef(null);S.useEffect(()=>{const t=k.current;if(t!==null){const Y=u.getBoundingClientRect();t.style.top=`${Y.y}px`,t.style.left=`${Y.x}px`}},[u]),S.useEffect(()=>{const t=Y=>{const B=k.current;B!==null&&!B.contains(Y.target)&&Y.stopPropagation()};return window.addEventListener("click",t),()=>window.removeEventListener("click",t)},[x]);const D=i.get(l.id);if(D===void 0)return null;const[T,L]=D;return V("div",{className:"dropdown",ref:k,onPointerMove:t=>{t.stopPropagation()},onPointerDown:t=>{t.stopPropagation()},onPointerUp:t=>{t.stopPropagation()},onClick:t=>{t.stopPropagation()},children:[m("button",{className:"item",onClick:()=>{R(t=>{e.$addUpdateTag("history-push"),t.updateCellType(T,L,l.type==="normal"?"header":"normal")}),x()},children:m("span",{className:"text",children:l.type==="normal"?"Make header":"Remove header"})}),m("button",{className:"item",onClick:()=>{E([l.id],()=>{const t=e.$getRoot();t.clear(),t.append(e.$createParagraphNode())}),x()},children:m("span",{className:"text",children:"Clear cell"})}),m("hr",{}),l.type==="header"&&L===0&&V(Se,{children:[$!==null&&$.x===T&&m("button",{className:"item",onClick:()=>{w(null),x()},children:m("span",{className:"text",children:"Remove sorting"})}),($===null||$.x!==T||$.type==="descending")&&m("button",{className:"item",onClick:()=>{w({type:"ascending",x:T}),x()},children:m("span",{className:"text",children:"Sort ascending"})}),($===null||$.x!==T||$.type==="ascending")&&m("button",{className:"item",onClick:()=>{w({type:"descending",x:T}),x()},children:m("span",{className:"text",children:"Sort descending"})}),m("hr",{})]}),m("button",{className:"item",onClick:()=>{R(t=>{e.$addUpdateTag("history-push"),t.insertRowAt(L)}),x()},children:m("span",{className:"text",children:"Insert row above"})}),m("button",{className:"item",onClick:()=>{R(t=>{e.$addUpdateTag("history-push"),t.insertRowAt(L+1)}),x()},children:m("span",{className:"text",children:"Insert row below"})}),m("hr",{}),m("button",{className:"item",onClick:()=>{R(t=>{e.$addUpdateTag("history-push"),t.insertColumnAt(T)}),x()},children:m("span",{className:"text",children:"Insert column left"})}),m("button",{className:"item",onClick:()=>{R(t=>{e.$addUpdateTag("history-push"),t.insertColumnAt(T+1)}),x()},children:m("span",{className:"text",children:"Insert column right"})}),m("hr",{}),s[0].cells.length!==1&&m("button",{className:"item",onClick:()=>{R(t=>{e.$addUpdateTag("history-push"),t.deleteColumnAt(T)}),x()},children:m("span",{className:"text",children:"Delete column"})}),s.length!==1&&m("button",{className:"item",onClick:()=>{R(t=>{e.$addUpdateTag("history-push"),t.deleteRowAt(L)}),x()},children:m("span",{className:"text",children:"Delete row"})}),m("button",{className:"item",onClick:()=>{R(t=>{e.$addUpdateTag("history-push"),t.selectNext(),t.remove()}),x()},children:m("span",{className:"text",children:"Delete table"})})]})}function Fe({cell:l,cellCoordMap:s,cellEditor:i,isEditing:u,isSelected:E,isPrimarySelected:x,theme:R,updateCellsByID:w,updateTableNode:$,rows:k,setSortingOptions:D,sortingOptions:T}){const[L,t]=S.useState(!1),Y=S.useRef(null),B=l.type!=="normal",Z=l.json,ce=B?"th":"td",ee=l.width,C=Y.current,K=s.get(l.id),H=T!==null&&K!==void 0&&K[0]===T.x&&K[1]===0;return S.useEffect(()=>{(u||!x)&&t(!1)},[u,x]),V(ce,{className:`${R.tableCell} ${B?R.tableCellHeader:""} ${E?R.tableCellSelected:""}`,"data-id":l.id,tabIndex:-1,style:{width:ee!==null?ee:void 0},children:[x&&m("div",{className:`${R.tableCellPrimarySelected} ${u?R.tableCellEditing:""}`}),x&&u?m(He,{cellEditor:i}):V(Se,{children:[m("div",{dangerouslySetInnerHTML:{__html:Z===""?ke(R):ve(Z,i)}}),m("div",{className:R.tableCellResizer,"data-table-resize":"true"})]}),x&&!u&&m("div",{className:R.tableCellActionButtonContainer,ref:Y,children:m("button",{className:R.tableCellActionButton,onClick:te=>{t(!L),te.stopPropagation()},children:m("i",{className:"chevron-down"})})}),L&&C!==null&&_e.createPortal(m(Je,{cell:l,menuElem:C,updateCellsByID:w,onClose:()=>t(!1),updateTableNode:$,cellCoordMap:s,rows:k,setSortingOptions:D,sortingOptions:T}),document.body),H&&m("div",{className:R.tableCellSortedIndicator})]})}function qe({nodeKey:l,rows:s,theme:i}){const[u,E,x]=De.useLexicalNodeSelection(l),R=S.useRef({point:0,size:0}),[w,$]=S.useState(null),k=S.useRef(null),D=S.useRef(null),T=S.useRef(null),{cellEditorConfig:L}=S.useContext(Ne),[t,Y]=S.useState(!1),[B,Z]=S.useState(!1),[ce,ee]=S.useState(!1),[C]=Me.useLexicalComposerContext(),K=S.useRef(!1),[H,te]=S.useState(null),G=S.useRef(null),M=S.useMemo(()=>{const a=new Map;for(let N=0;N<s.length;N++){const A=s[N].cells;for(let g=0;g<A.length;g++){const b=A[g];a.set(b.id,[g,N])}}return a},[s]),O=S.useMemo(()=>{if(w===null)return s;const a=s.slice(1);return a.sort((N,I)=>{const A=N.cells,g=I.cells,b=w.x,v=fe.get(A[b].json)||"",_=fe.get(g[b].json)||"";return v===""||_===""?1:w.type==="ascending"?v.localeCompare(_):_.localeCompare(v)}),a.unshift(s[0]),a},[s,w]),[d,F]=S.useState(null),y=S.useMemo(()=>{if(L===null)return null;const a=e.createEditor({namespace:L.namespace,nodes:L.nodes,onError:N=>L.onError(N,a),theme:L.theme});return a},[L]),[W,z]=S.useState([]),pe=S.useMemo(()=>new Set(W),[W]);S.useEffect(()=>{const a=G.current;u&&document.activeElement===document.body&&a!==null&&a.focus()},[u]);const P=S.useCallback(a=>{C.update(()=>{const N=e.$getNodeByKey(l);Oe(N)&&a(N)})},[C,l]),ye=()=>{P(a=>{e.$addUpdateTag("history-push"),a.addColumns(1)})},be=()=>{P(a=>{e.$addUpdateTag("history-push"),a.addRows(1)})},j=S.useCallback((a,N,I)=>{const A=O[N].cells[a].id;if(D.current=A,I){const g=he(O,d,A,M);z(g)}else F(A),z(J),ue(G.current,A)},[M,d,O]),q=S.useCallback(()=>{if(y!==null&&d!==null){const a=JSON.stringify(y.getEditorState());P(N=>{const I=M.get(d);if(I===void 0)return;e.$addUpdateTag("history-push");const[A,g]=I;N.updateCellJSON(A,g,a)})}},[M,y,d,P]),ne=S.useCallback(()=>{setTimeout(()=>{var N;const a=C.getRootElement();a!==null&&(a.focus({preventScroll:!0}),(N=window.getSelection())==null||N.removeAllRanges())},20)},[C]);S.useEffect(()=>{const a=G.current;if(a===null)return;const N=Ce(C),I=_=>{const n=_.clientX-g.x,r=_.clientY-g.y;return n<5||r<5},A=_=>{const n=de(_.target);if(n!==null&&C.isEditable()&&a.contains(_.target)){if(I(_)){E(!0),F(null),ne();return}if(E(!1),Ye(_.target)){te(n),a.style.userSelect="none",R.current={point:_.clientX,size:ze(_.target)};return}K.current=!0,d!==n?(t&&q(),F(n),Y(!1),D.current=n):D.current=null,z(J)}else d!==null&&!Xe(_.target)&&(E(!1),K.current=!1,t&&q(),F(null),z(J),Y(!1),D.current=null)},g=a.getBoundingClientRect(),b=_=>{if(H!==null){const r=T.current;if(r!==null){const{size:o,point:f}=R.current,p=_.clientX-f,h=o+p;let c=_.clientX-g.x;c<10?c=10:c>g.width-10?c=g.width-10:h<20&&(c=f-o+20-g.x),r.style.left=`${c}px`}return}if(!t){const{clientX:r,clientY:o}=_,{width:f,x:p,y:h,height:c}=g,X=r>p+f*.9&&r<p+f+40&&!K.current;Z(X);const U=_.target===k.current||o>h+c*.85&&o<h+c+5&&!K.current;ee(U)}if(t||!K.current||d===null)return;const n=de(_.target);if(n!==null&&n!==D.current){W.length===0&&(a.style.userSelect="none");const r=he(O,d,n,M);r.length===1?z(J):z(r),D.current=n}},v=_=>{var n;if(H!==null){const{size:r,point:o}=R.current,f=_.clientX-o;let p=r+f;p<10&&(p=10),P(h=>{const[c]=M.get(H);e.$addUpdateTag("history-push"),h.updateColumnWidth(c,p)}),te(null)}a!==null&&W.length>1&&K.current&&(a.style.userSelect="text",(n=window.getSelection())==null||n.removeAllRanges()),K.current=!1};return N.addEventListener("pointerdown",A),N.addEventListener("pointermove",b),N.addEventListener("pointerup",v),()=>{N.removeEventListener("pointerdown",A),N.removeEventListener("pointermove",b),N.removeEventListener("pointerup",v)}},[y,C,t,O,q,d,pe,W,M,H,P,E,ne]),S.useEffect(()=>{if(!t&&d!==null){const a=Ce(C),N=g=>{if(g!==null&&y!==null){const b=g.json,v=y.parseEditorState(b);y.setEditorState(v)}},I=g=>{const b=de(g.target);if(b===d&&C.isEditable()){const v=ae(O,b,M);N(v),Y(!0),z(J)}},A=g=>{const b=g.keyCode;if(b===16||b===27||b===9||b===37||b===38||b===39||b===40||b===8||b===46||!C.isEditable())return;if(b===13&&g.preventDefault(),!t&&d!==null&&C.getEditorState().read(()=>e.$getSelection()===null)&&g.target.contentEditable!=="true"){if(Ke(b,g.shiftKey,g.metaKey,g.ctrlKey)){C.dispatchCommand(e.COPY_COMMAND,g);return}if(Ue(b,g.shiftKey,g.metaKey,g.ctrlKey)){C.dispatchCommand(e.CUT_COMMAND,g);return}if(We(b,g.shiftKey,g.metaKey,g.ctrlKey)){C.dispatchCommand(e.PASTE_COMMAND,g);return}}if(g.metaKey||g.ctrlKey||g.altKey)return;const v=ae(O,d,M);N(v),Y(!0),z(J)};return a.addEventListener("dblclick",I),a.addEventListener("keydown",A),()=>{a.removeEventListener("dblclick",I),a.removeEventListener("keydown",A)}}},[y,C,t,O,d,M]);const ie=S.useCallback((a,N)=>{Q(O,a,M,y,P,N)},[M,y,O,P]),le=S.useCallback(()=>d!==null&&!t?(ie([d,...W],()=>{const a=e.$getRoot();a.clear(),a.append(e.$createParagraphNode())}),!0):(u&&P(a=>{e.$addUpdateTag("history-push"),a.selectNext(),a.remove()}),!1),[t,u,d,W,ie,P]);if(S.useEffect(()=>{const a=G.current;if(a===null)return;const N=(n,r,o,f)=>{const p=n instanceof KeyboardEvent?null:n.clipboardData;if(n.preventDefault(),p!=null)p.setData("text/html",r),p.setData("text/plain",f),p.setData("application/x-lexical-editor",o);else{const h=navigator.clipboard;if(h!=null){const c=[new ClipboardItem({"text/html":new Blob([r],{type:"text/html"})})];h.write(c)}}},I=async(n,r)=>{try{return n instanceof DataTransfer?n.getData(r):n instanceof ClipboardItem?await(await n.getType(r)).text():""}catch{return""}},A=async n=>{let r=(n instanceof InputEvent?null:n.clipboardData)||null;if(d!==null&&y!==null){if(n.preventDefault(),r===null)try{r=(await navigator.clipboard.read())[0]}catch{}const o=r!==null?await I(r,"application/x-lexical-editor"):"";if(o)try{const h=JSON.parse(o);if(h.namespace===C._config.namespace&&Array.isArray(h.nodes)){Q(O,[d],M,y,P,()=>{const c=e.$getRoot();c.clear(),c.append(e.$createParagraphNode()),c.selectEnd();const X=oe.$generateNodesFromSerializedNodes(h.nodes),U=e.$getSelection();e.$isRangeSelection(U)&&oe.$insertGeneratedNodes(y,X,U)});return}}catch{}const f=r!==null?await I(r,"text/html"):"";if(f)try{const c=new DOMParser().parseFromString(f,"text/html"),X=c.querySelector("table");if(X!=null){const U=we(X);P(se=>{const[re,Ee]=M.get(d);e.$addUpdateTag("history-push"),se.mergeRows(re,Ee,U)});return}Q(O,[d],M,y,P,()=>{const U=e.$getRoot();U.clear(),U.append(e.$createParagraphNode()),U.selectEnd();const se=Re.$generateNodesFromDOM(C,c),re=e.$getSelection();e.$isRangeSelection(re)&&oe.$insertGeneratedNodes(y,se,re)});return}catch{}const p=r!==null?await I(r,"text/plain"):"";p!=null&&Q(O,[d],M,y,P,()=>{const h=e.$getRoot();h.clear(),h.selectEnd();const c=e.$getSelection();c!==null&&c.insertRawText(p)})}},g=n=>{if(d!==null&&y!==null){const o=ae(O,d,M).json,f=me.get(o)||null;if(f===null)return;const p=y.parseEditorState(o),h=p.read(()=>e.$getRoot().getTextContent()),c=p.read(()=>JSON.stringify(oe.$generateJSONFromSelectedNodes(y,null)));N(n,f,c,h)}},b=n=>{const r=D.current;if(d!==null&&y!==null&&r!==null){const o=xe(d,r,M);if(o===null)return;const f=$e(O,o),p=f.outerHTML,h=f.outerText,c=C.getEditorState().read(()=>e.$getNodeByKey(l).exportJSON());c.rows=Be(O,o);const X={namespace:y._config.namespace,nodes:[c]},U=JSON.stringify(X);N(n,p,U,h)}},v=(n,r)=>{const o=e.$getSelection();return d!==null&&!t&&o===null&&r===C?(A(n),K.current=!1,z(J),!0):!1},_=(n,r)=>{const o=e.$getSelection();return d!==null&&!t&&o===null&&r===C?(W.length===0?g(n):b(n),!0):!1};return Te.mergeRegister(C.registerCommand(e.CLICK_COMMAND,n=>{const r=e.$getSelection();return!!e.$isNodeSelection(r)},e.COMMAND_PRIORITY_LOW),C.registerCommand(e.PASTE_COMMAND,v,e.COMMAND_PRIORITY_LOW),C.registerCommand(e.COPY_COMMAND,_,e.COMMAND_PRIORITY_LOW),C.registerCommand(e.CUT_COMMAND,(n,r)=>_(n,r)?(le(),!0):!1,e.COMMAND_PRIORITY_LOW),C.registerCommand(e.KEY_BACKSPACE_COMMAND,le,e.COMMAND_PRIORITY_LOW),C.registerCommand(e.KEY_DELETE_COMMAND,le,e.COMMAND_PRIORITY_LOW),C.registerCommand(e.FORMAT_TEXT_COMMAND,n=>d!==null&&!t?(Q(O,[d,...W],M,y,P,()=>{Pe().formatText(n)}),!0):!1,e.COMMAND_PRIORITY_LOW),C.registerCommand(e.KEY_ENTER_COMMAND,(n,r)=>{const o=e.$getSelection();if(d===null&&!t&&e.$isNodeSelection(o)&&o.has(l)&&o.getNodes().length===1&&r===C){const f=O[0].cells[0].id;return F(f),ue(a,f),n.preventDefault(),n.stopPropagation(),x(),!0}return!1},e.COMMAND_PRIORITY_LOW),C.registerCommand(e.KEY_TAB_COMMAND,n=>{const r=e.$getSelection();if(!t&&r===null&&d!==null){const o=n.shiftKey,[f,p]=M.get(d);n.preventDefault();let h=null,c=null;if(f===0&&o?p!==0&&(c=p-1,h=O[c].cells.length-1):f===O[p].cells.length-1&&!o?p!==O.length-1&&(c=p+1,h=0):o?(h=f-1,c=p):(h=f+1,c=p),h!==null&&c!==null)return j(h,c,!1),!0}return!1},e.COMMAND_PRIORITY_LOW),C.registerCommand(e.KEY_ARROW_UP_COMMAND,(n,r)=>{const o=e.$getSelection();if(!t&&o===null){const f=n.shiftKey,p=f&&D.current||d;if(p!==null){const[h,c]=M.get(p);if(c!==0)return j(h,c-1,f),!0}}return!e.$isRangeSelection(o)||r!==y?!1:o.isCollapsed()&&o.anchor.getNode().getTopLevelElementOrThrow().getPreviousSibling()===null?(n.preventDefault(),!0):!1},e.COMMAND_PRIORITY_LOW),C.registerCommand(e.KEY_ARROW_DOWN_COMMAND,(n,r)=>{const o=e.$getSelection();if(!t&&o===null){const f=n.shiftKey,p=f&&D.current||d;if(p!==null){const[h,c]=M.get(p);if(c!==O.length-1)return j(h,c+1,f),!0}}return!e.$isRangeSelection(o)||r!==y?!1:o.isCollapsed()&&o.anchor.getNode().getTopLevelElementOrThrow().getNextSibling()===null?(n.preventDefault(),!0):!1},e.COMMAND_PRIORITY_LOW),C.registerCommand(e.KEY_ARROW_LEFT_COMMAND,(n,r)=>{const o=e.$getSelection();if(!t&&o===null){const f=n.shiftKey,p=f&&D.current||d;if(p!==null){const[h,c]=M.get(p);if(h!==0)return j(h-1,c,f),!0}}return!e.$isRangeSelection(o)||r!==y?!1:o.isCollapsed()&&o.anchor.offset===0?(n.preventDefault(),!0):!1},e.COMMAND_PRIORITY_LOW),C.registerCommand(e.KEY_ARROW_RIGHT_COMMAND,(n,r)=>{const o=e.$getSelection();if(!t&&o===null){const f=n.shiftKey,p=f&&D.current||d;if(p!==null){const[h,c]=M.get(p);if(h!==O[c].cells.length-1)return j(h+1,c,f),!0}}if(!e.$isRangeSelection(o)||r!==y)return!1;if(o.isCollapsed()){const f=o.anchor;if(f.type==="text"&&f.offset===f.getNode().getTextContentSize()||f.type==="element"&&f.offset===f.getNode().getChildrenSize())return n.preventDefault(),!0}return!1},e.COMMAND_PRIORITY_LOW),C.registerCommand(e.KEY_ESCAPE_COMMAND,(n,r)=>{const o=e.$getSelection();return!t&&o===null&&r===C?(E(!0),F(null),ne(),!0):e.$isRangeSelection(o)&&t?(q(),Y(!1),d!==null&&setTimeout(()=>{ue(a,d)},20),!0):!1},e.COMMAND_PRIORITY_LOW))},[M,y,le,x,C,t,j,l,d,O,q,ne,W,E,P]),y!==null)return V("div",{style:{position:"relative"},children:[m("table",{className:`${i.table} ${u?i.tableSelected:""}`,ref:G,tabIndex:-1,children:m("tbody",{children:O.map(a=>m("tr",{className:i.tableRow,children:a.cells.map(N=>{const{id:I}=N;return m(Fe,{cell:N,theme:i,isSelected:pe.has(I),isPrimarySelected:d===I,isEditing:t,sortingOptions:w,cellEditor:y,updateCellsByID:ie,updateTableNode:P,cellCoordMap:M,rows:O,setSortingOptions:$},I)})},a.id))})}),B&&m("button",{className:i.tableAddColumns,onClick:ye}),ce&&m("button",{className:i.tableAddRows,onClick:be,ref:k}),H!==null&&m("div",{className:i.tableResizeRuler,ref:T})]})}export{qe as default};
